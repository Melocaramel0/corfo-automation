import { AgenteMultiFase } from './agenteMultiFase';
import { extraerPrimerFormularioMultiFase } from '../scraping/extraerFormularios';
import { obtenerConfiguracion } from './configuraciones';
import path from 'path';

/**
 * Demo completo del sistema de an√°lisis multi-fase de formularios CORFO
 * - Extrae el primer formulario disponible
 * - Navega por todas las fases
 * - Detecta campos obligatorios autom√°ticamente
 * - Mide tiempos de autocompletado y validaci√≥n
 * - Genera reporte detallado
 * - NO env√≠a el formulario (solo testing)
 */
async function demoAnalisisMultiFase() {
    console.log('üéØ DEMO AN√ÅLISIS MULTI-FASE CORFO');
    console.log('=================================');
    console.log('Este demo demuestra las capacidades del agente para:');
    console.log('‚úÖ Extraer formularios multi-fase autom√°ticamente');
    console.log('‚úÖ Detectar campos obligatorios por validaci√≥n visual');
    console.log('‚úÖ Autocompletar campos inteligentemente');
    console.log('‚úÖ Validar y revisar cada fase');
    console.log('‚úÖ Medir tiempos de procesamiento');
    console.log('‚úÖ Generar reportes detallados');
    console.log('‚ö†Ô∏è NO env√≠a el formulario (solo testing)\n');

    try {
        // Paso 1: Extraer formulario multi-fase
        console.log('üîÑ PASO 1: Extrayendo formulario multi-fase de CORFO...');
        console.log('---------------------------------------------------');
        
        const formulario = await extraerPrimerFormularioMultiFase();
        
        if (!formulario) {
            console.error('‚ùå No se pudo extraer ning√∫n formulario');
            return;
        }
        
        console.log('‚úÖ Formulario extra√≠do exitosamente');
        console.log(`üìã T√≠tulo: ${formulario.titulo}`);
        console.log(`üîó URL: ${formulario.url}`);
        console.log(`üìä Fases encontradas: ${formulario.totalFases}`);
        console.log(`üìù Total de campos: ${formulario.campos.length}`);
        console.log(`‚ö†Ô∏è Campos marcados como obligatorios: ${formulario.campos.filter(c => c.requerido).length}`);
        
        // Mostrar resumen de cada fase
        console.log('\nüìã RESUMEN POR FASES:');
        formulario.fases.forEach(fase => {
            const obligatorios = fase.campos.filter(c => c.requerido).length;
            console.log(`   Fase ${fase.numero}: "${fase.titulo}" - ${fase.campos.length} campos (${obligatorios} obligatorios)`);
        });
        
        // Paso 2: Configurar agente para demo
        console.log('\nü§ñ PASO 2: Configurando agente para an√°lisis...');
        console.log('----------------------------------------------');
        
        const configuracion = obtenerConfiguracion('demo');
        const agente = new AgenteMultiFase(configuracion);
        
        console.log(`‚úÖ Agente configurado en modo: demo`);
        console.log(`‚ö° Debug habilitado: ${configuracion.modoDebug}`);
        console.log(`üéØ Configuraci√≥n optimizada para: demostraciones balanceadas`);
        
        // Paso 3: Procesar formulario multi-fase
        console.log('\nüöÄ PASO 3: Procesando formulario multi-fase...');
        console.log('==============================================');
        
        const resultado = await agente.procesarFormularioMultiFase(formulario);
        
        // Paso 4: Generar reporte JSON
        console.log('\nüìÑ PASO 4: Generando reporte detallado...');
        console.log('==========================================');
        
        const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const rutaReporte = path.join(__dirname, '../data', `reporte_multifase_${fechaHora}.json`);
        
        await agente.generarReporteJSON(resultado, rutaReporte);
        
        // Paso 5: An√°lisis final y conclusiones
        console.log('\nüéØ PASO 5: AN√ÅLISIS FINAL Y CONCLUSIONES');
        console.log('=======================================');
        
        // Calcular velocidad de procesamiento
        const velocidadCamposPorSegundo = (resultado.formulario.totalCampos / (resultado.tiempos.tiempoTotalProcesamiento / 1000)).toFixed(1);
        const velocidadFasesPorMinuto = (resultado.formulario.totalFases / (resultado.tiempos.tiempoTotalProcesamiento / 60000)).toFixed(1);
        
        console.log('\nüìà M√âTRICAS DE RENDIMIENTO:');
        console.log(`   üöÄ Velocidad: ${velocidadCamposPorSegundo} campos/segundo`);
        console.log(`   üìã Velocidad: ${velocidadFasesPorMinuto} fases/minuto`);
        console.log(`   ‚è±Ô∏è Tiempo total: ${(resultado.tiempos.tiempoTotalProcesamiento/1000).toFixed(2)} segundos`);
        console.log(`   üéØ √âxito general: ${resultado.resumenGeneral.porcentajeExito}%`);
        
        console.log('\nüèÜ CAPACIDADES DEMOSTRADAS:');
        console.log('   ‚úÖ Extracci√≥n autom√°tica de formularios multi-fase');
        console.log('   ‚úÖ Navegaci√≥n inteligente entre fases');
        console.log('   ‚úÖ Detecci√≥n precisa de campos obligatorios');
        console.log('   ‚úÖ Autocompletado contextual por tipo de campo');
        console.log('   ‚úÖ Validaci√≥n exhaustiva por fase');
        console.log('   ‚úÖ Medici√≥n de rendimiento en tiempo real');
        console.log('   ‚úÖ Generaci√≥n de reportes detallados');
        console.log('   ‚úÖ An√°lisis de optimizaci√≥n y recomendaciones');
        
        console.log('\nüí° VALOR PARA CORFO:');
        console.log('   üéØ Reducci√≥n significativa de tiempo de revisi√≥n');
        console.log('   üìä An√°lisis autom√°tico de calidad de formularios');
        console.log('   ‚ö° Procesamiento r√°pido y eficiente');
        console.log('   üîç Detecci√≥n autom√°tica de patrones y errores');
        console.log('   üìà M√©tricas objetivas de rendimiento');
        console.log('   üõ°Ô∏è Validaci√≥n sin riesgo (no env√≠a formularios)');
        
        console.log('\n‚úÖ DEMO COMPLETADO EXITOSAMENTE');
        console.log(`üìÑ Reporte detallado guardado en: ${rutaReporte}`);
        console.log('üéâ El agente est√° listo para implementaci√≥n en producci√≥n');
        
    } catch (error) {
        console.error('\n‚ùå ERROR EN EL DEMO:', error);
        
        console.log('\nüîß POSIBLES SOLUCIONES:');
        console.log('   1. Verificar conexi√≥n a internet');
        console.log('   2. Revisar credenciales de acceso a CORFO');
        console.log('   3. Confirmar que el sitio de CORFO est√© disponible');
        console.log('   4. Verificar que haya formularios disponibles');
        
        throw error;
    }
}

/**
 * Demo simplificado que usa un formulario de ejemplo (sin web scraping)
 * √ötil para testing r√°pido del sistema de an√°lisis
 */
async function demoSimplificado() {
    console.log('üéØ DEMO SIMPLIFICADO - SIN WEB SCRAPING');
    console.log('======================================');
    console.log('Este demo usa un formulario de ejemplo para mostrar capacidades\n');
    
    // Crear formulario de ejemplo multi-fase
    const formularioEjemplo = {
        titulo: 'Formulario de Ejemplo Multi-Fase',
        url: 'https://ejemplo.cl/formulario',
        descripcion: 'Formulario de demostraci√≥n con m√∫ltiples fases',
        campos: [
            // Fase 1: Informaci√≥n b√°sica
            { tipo: 'text', label: 'Nombre de la empresa', nombre: 'empresa', requerido: true },
            { tipo: 'text', label: 'RUT empresa', nombre: 'rut_empresa', requerido: true },
            { tipo: 'email', label: 'Email contacto', nombre: 'email', requerido: true },
            { tipo: 'tel', label: 'Tel√©fono', nombre: 'telefono', requerido: true },
            
            // Fase 2: Proyecto
            { tipo: 'text', label: 'Nombre del proyecto', nombre: 'proyecto', requerido: true },
            { tipo: 'textarea', label: 'Descripci√≥n del proyecto', nombre: 'descripcion', requerido: true },
            { tipo: 'number', label: 'Monto solicitado', nombre: 'monto', requerido: true },
            { tipo: 'date', label: 'Fecha inicio', nombre: 'fecha_inicio', requerido: true },
            
            // Fase 3: Documentaci√≥n
            { tipo: 'file', label: 'Proyecto detallado', nombre: 'archivo_proyecto', requerido: true },
            { tipo: 'file', label: 'Estados financieros', nombre: 'estados_financieros', requerido: false },
            { tipo: 'checkbox', label: 'Acepto t√©rminos', nombre: 'acepta_terminos', requerido: true },
            { tipo: 'select', label: 'Regi√≥n', nombre: 'region', requerido: true, opciones: ['Metropolitana', 'Valpara√≠so', 'Biob√≠o'] }
        ],
        fases: [
            {
                numero: 1,
                titulo: 'Informaci√≥n B√°sica de la Empresa',
                campos: [
                    { tipo: 'text', label: 'Nombre de la empresa', nombre: 'empresa', requerido: true },
                    { tipo: 'text', label: 'RUT empresa', nombre: 'rut_empresa', requerido: true },
                    { tipo: 'email', label: 'Email contacto', nombre: 'email', requerido: true },
                    { tipo: 'tel', label: 'Tel√©fono', nombre: 'telefono', requerido: true }
                ],
                esUltimaFase: false
            },
            {
                numero: 2,
                titulo: 'Informaci√≥n del Proyecto',
                campos: [
                    { tipo: 'text', label: 'Nombre del proyecto', nombre: 'proyecto', requerido: true },
                    { tipo: 'textarea', label: 'Descripci√≥n del proyecto', nombre: 'descripcion', requerido: true },
                    { tipo: 'number', label: 'Monto solicitado', nombre: 'monto', requerido: true },
                    { tipo: 'date', label: 'Fecha inicio', nombre: 'fecha_inicio', requerido: true }
                ],
                esUltimaFase: false
            },
            {
                numero: 3,
                titulo: 'Documentaci√≥n y Finalizaci√≥n',
                campos: [
                    { tipo: 'file', label: 'Proyecto detallado', nombre: 'archivo_proyecto', requerido: true },
                    { tipo: 'file', label: 'Estados financieros', nombre: 'estados_financieros', requerido: false },
                    { tipo: 'checkbox', label: 'Acepto t√©rminos', nombre: 'acepta_terminos', requerido: true },
                    { tipo: 'select', label: 'Regi√≥n', nombre: 'region', requerido: true, opciones: ['Metropolitana', 'Valpara√≠so', 'Biob√≠o'] }
                ],
                esUltimaFase: true
            }
        ],
        totalFases: 3
    };
    
    try {
        const configuracion = obtenerConfiguracion('demo');
        const agente = new AgenteMultiFase(configuracion);
        
        console.log('ü§ñ Agente configurado en modo demo');
        console.log('ü§ñ Procesando formulario de ejemplo...');
        const resultado = await agente.procesarFormularioMultiFase(formularioEjemplo);
        
        // Generar reporte
        const fechaHora = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const rutaReporte = path.join(__dirname, '../data', `reporte_ejemplo_${fechaHora}.json`);
        await agente.generarReporteJSON(resultado, rutaReporte);
        
        console.log('\n‚úÖ DEMO SIMPLIFICADO COMPLETADO');
        console.log(`üìÑ Reporte guardado en: ${rutaReporte}`);
        
    } catch (error) {
        console.error('‚ùå Error en demo simplificado:', error);
        throw error;
    }
}

// Funci√≥n principal que permite elegir el tipo de demo
async function main() {
    const args = process.argv.slice(2);
    const tipoDemo = args[0] || 'completo';
    
    console.log('üéØ SISTEMA DE AN√ÅLISIS MULTI-FASE CORFO');
    console.log('======================================\n');
    
    if (tipoDemo === 'simple' || tipoDemo === 'simplificado') {
        await demoSimplificado();
    } else {
        await demoAnalisisMultiFase();
    }
}

// Ejecutar si se llama directamente
if (require.main === module) {
    main()
        .then(() => {
            console.log('\nüéâ Proceso completado exitosamente');
            process.exit(0);
        })
        .catch((error) => {
            console.error('\nüí• Error fatal:', error);
            process.exit(1);
        });
}

export { demoAnalisisMultiFase, demoSimplificado }; 